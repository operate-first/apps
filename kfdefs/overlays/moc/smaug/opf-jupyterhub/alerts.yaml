apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: jupyterhub-alerts
spec:
  groups:
    - name: jupyterhub
      rules:
        - alert: PVCFillingUp
          annotations:
            description: >-
              The PersistentVolume claimed by {{ $labels.persistentvolumeclaim
              }} in Namespace {{ $labels.namespace }} is only {{ $value |
              humanizePercentage }} free.
            summary: PersistentVolume is filling up.
            # Tag the user who owns the PVC
            user: >-
              @{{ reReplaceAll "^jupyterhub-nb-|-pvc$" ""
              $labels.persistentvolumeclaim }}
            # Link the runbook with instructions to fix this issue
            runbook: >-
              https://github.com/operate-first/apps/blob/master/docs/content/odh/jupyterhub/runbook.md#insufficient-disk-space-for-notebook-pod
          # Alert when 90% of PVC is full
          expr: >-
            kubelet_volume_stats_available_bytes{namespace="opf-jupyterhub"}/kubelet_volume_stats_capacity_bytes{namespace="opf-jupyterhub"}
            < 0.1
          labels:
            severity: critical
    - name: SLOs-probe_success
      rules:
        - alert: RHODS Probe Success Burn Rate
          annotations:
            message: 'High error budget burn for {{ $labels.instance }} (current value: {{ $value }}).'
            triage: "https://gitlab.cee.redhat.com/service/managed-tenants-sops/-/blob/main/RHODS/JupyterHub/rhods-probe-success-burn-rate.md"
            summary: RHODS Route Error Burn Rate
          expr: |
            sum(probe_success:burnrate5m{instance=~"jupyterhub"}) by (instance) > (14.40 * (1-0.98000))
            and
            sum(probe_success:burnrate1h{instance=~"jupyterhub"}) by (instance) > (14.40 * (1-0.98000))
          for: 2m
          labels:
            severity: critical
        - alert: RHODS Probe Success Burn Rate
          annotations:
            message: 'High error budget burn for {{ $labels.instance }} (current value: {{ $value }}).'
            triage: "https://gitlab.cee.redhat.com/service/managed-tenants-sops/-/blob/main/RHODS/JupyterHub/rhods-probe-success-burn-rate.md"
            summary: RHODS Route Error Burn Rate
          expr: |
            sum(probe_success:burnrate30m{instance=~"jupyterhub"}) by (instance) > (6.00 * (1-0.98000))
            and
            sum(probe_success:burnrate6h{instance=~"jupyterhub"}) by (instance) > (6.00 * (1-0.98000))
          for: 15m
          labels:
            severity: critical
        - alert: RHODS Probe Success Burn Rate
          annotations:
            message: 'High error budget burn for {{ $labels.instance }} (current value: {{ $value }}).'
            triage: "https://gitlab.cee.redhat.com/service/managed-tenants-sops/-/blob/main/RHODS/JupyterHub/rhods-probe-success-burn-rate.md"
            summary: RHODS Route Error Burn Rate
          expr: |
            sum(probe_success:burnrate2h{instance=~"jupyterhub"}) by (instance) > (3.00 * (1-0.98000))
            and
            sum(probe_success:burnrate1d{instance=~"jupyterhub"}) by (instance) > (3.00 * (1-0.98000))
          for: 1h
          labels:
            severity: warning
        - alert: RHODS Probe Success Burn Rate
          annotations:
            message: 'High error budget burn for {{ $labels.instance }} (current value: {{ $value }}).'
            triage: "https://gitlab.cee.redhat.com/service/managed-tenants-sops/-/blob/main/RHODS/JupyterHub/rhods-probe-success-burn-rate.md"
            summary: RHODS Route Error Burn Rate
          expr: |
            sum(probe_success:burnrate6h{instance=~"jupyterhub"}) by (instance) > (1.00 * (1-0.98000))
            and
            sum(probe_success:burnrate3d{instance=~"jupyterhub"}) by (instance) > (1.00 * (1-0.98000))
          for: 3h
          labels:
            severity: warning
